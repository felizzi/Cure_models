---
title: "Step-by-step guide to informed cure"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_pack, include = FALSE}
require(flexsurv)
```
## Loading the trial data
```{r load}
trial_data <- read.csv(paste0("libraries/example.csv")) 
```

Source the required functions. The files contain the key functions 
```{r source}
source("functions/hazard_script.R")
source("functions/likelihood_funs.r")
```

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r hazard, message = FALSE, warning = FALSE }
hazard_out <- hazard_time(table_ = trial_data, 
                          evttme = "TIME" , 
                          sex = "SEX", 
                          age = "AGE", 
                          year = "YEAR", 
                          country_trial = "COUNTRY", 
                          country_output = NULL)
```

Populate the dataset with the subject-specific hazard and compute the residual background mortality as the average of the residual background mortality for the subjects in the trial.
```{r dataset hazard}
trial_data$rate_mod <- hazard_out$rate_vec
surv_mean <- colSums(hazard_out$surv_mat, na.rm = T)/length(which(!is.na(hazard_out$surv_mat[,1])))
``` 

Specify the type of models and the pre-specified cure values
```{r models_cures}
models <- c("exponential", "weibull", "llogis", "lognormal", "gompertz", "gamma", "gengamma")
cure_vals <- c(0,0.01,0.02,0.03,0.04,0.05,0.1,0.15,0.2)
``` 



Loop to estimate the parameters of the parametric fits for each value of the cure fraction presented above. The cure fraction is passed as input to the ***ll.mix_f*** function.

```{r model_loop, message=FALSE, warning = FALSE}
for (i in 1:length(models)){
  fsr_fits_ <- flexsurvreg(Surv(as.numeric(TIME), CNSR)~1, data = trial_data, dist = models[i])
  surv_fits_ <- survfit(Surv(as.numeric(TIME), CNSR)~1, data = trial_data )
  opt_obj_f_ <- list()
  
  for (j in 1:length(cure_vals)){
    fsr_use <- fsr_fits_$res[,'est'];
    opt_obj_f_[[j]] <- try(optim(par=c(fsr_use), 
                                 ll.mix_f, 
                                 pi_ = cure_vals[j],
                                 table = trial_data,
                                 time_col = "TIME",
                                 cen_col = "CNSR",
                                 rate_col = "rate_mod",
                                 method = "BFGS", 
                                 obj = fsr_fits_,
                                 hessian = TRUE) 
                           , silent = FALSE)
  }
}
```
  

 
Code Ended